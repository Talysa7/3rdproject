<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="board">
<!-- talysa7 -->
	<select id="getBoard" parameterType="int" resultType="db.BoardDataBean">
		select * from pao_view_board where board_no=#{board_no}
	</select>
	<select id="getBoardCount" resultType="int">
		select count(*) from pao_board
	</select>
	<select id="getBoardList" parameterType="int" resultType="db.TripDataBean">
		select *
		from pao_view_board
		order by board_level desc, board_no desc
		limit #{startRowNumber},#{endRowNumber}
	</select>

	<!-- 요거도 셀렉트키 바꿔서 확인필요. -->
	<insert id="insertBoard_no" parameterType="db.BoardDataBean" keyProperty="board_no">
       insert into pao_board (board_title, board_content, board_view_count, board_level, board_contact , board_reg_date, user_id )
      values(#{board_title}, #{board_content}, 0 , 0, #{board_contact}, sysdate, #{user_id})
      <selectKey keyProperty="board_no" resultType="int" order="AFTER">
         select LAST_INSERT_ID()
      </selectKey>
   	</insert>
   	<insert id="insertTrip" parameterType="db.BoardDataBean" keyProperty="trip_id">
   		insert into pao_trip(board_no,trip_member_count,coord_id,start_date,end_date) values(#{board_no},#{trip_member_count},#{coord_id},#{start_date},#{end_date})
	   	<selectKey keyProperty="trip_id" resultType="int" order="AFTER">
	       select LAST_INSERT_ID()
	    </selectKey>
    </insert>
	<!-- TODO: user관련. 나중에 체크후 user에 추가 
	<select id="getUserName" parameterType="String" resultType="String">
		select user_name from pao_user where user_id=#{user_id}
	</select>
	<select id="getUserId" parameterType="String" resultType="String">
		select user_id from pao_user where user_name=#{user_name}
	</select>
	<select id="isMember" parameterType="db.boardDataBean" resultType="int">
		select count(*) from pao_member where user_id=#{user_id} and trip_id in(
			select trip_id from pao_trip where board_no=#{board_no})
	</select>
	<select id="getMember" parameterType="int" resultType="java.util.List">
		select user_id from pao_members where trip_id=(select trip_id from pao_trip where board_no=#{board_no})
	</select>
	<select id="isTBMember" parameterType="db.BoardDataBean" resultType="int">
		select count(*) from pao_members where user_id=#{user_id} and
		trip_id in(
		select trip_id from pao_trip where
		board_no=#{board_no})
	</select>
	-->
	<update id="addCount" parameterType="int">
		update pao_board set board_view_count=board_view_count+1 where board_no=#{board_no}  
	</update>
	<update id="updateBoard" parameterType="db.BoardDataBean">
		update pao_board set board_title=#{board_title}, board_content=#{board_content},  board_level=#{board_level} where board_no=#{board_no}
	</update>
	<delete id="deleteTrip" parameterType="int">
		delete from pao_board where board_no=#{board_no}
	</delete>

	<select id="getBoardTags" parameterType="int" resultType="java.util.List">
		select tag_value 
		from pao_tag 
		where tag_id in
		(
			select tag_id 
			from pao_trip_tag 
			where b_no=#{b_no}
		)
	</select>

	<!-- trip insert -->
	<insert id="addTrip" parameterType="db.TripDataBean">
		insert into pao_trip 
		values(#{board_no}, #{trip_id}, #{trip_member_count}, #{coord_id}, #{start_date}, #{end_date})
	</insert>
	<!-- trip update -->
	<update id="addBoardViewCount" parameterType="int">
		update pao_board 
		set board_view_count=board_view_count+1 
		where board_no=#{board_no}
	</update>
	<update id="updateTrip" parameterType="db.BoardDataBean">
		update pao_trip 
		set trip_member_count=#{trip_member_count, coord_id=#{coord_id}, 
		start_date=#{start_date}, end_date=#{end_date}
		where trip_id=#{trip_id}
	</update>
	<update id="setBoardLevel" parameterType="db.BoardDataBean">
		update pao_board 
		set board_level=#{board_level} 
		where board_no=#{board_no}
	</update>
	<!-- trip delete -->
	<delete id="deleteTrip" parameterType="int">
		delete from pao_trip 
		where trip_id=#{trip_id}
	</delete>	
	<!--/////////////////////////////////////////////////// start-line pao_comment table ///////////////////////////////////////////////////-->
	<insert id="insertComment" parameterType="db.CmtDataBean">
		INSERT INTO pao_comment(comment_content, comment_reg_date, board_no, user_id)
		VALUES( #{comment_content, jdbcType=VARCHAR}, SYSDATE, #{board_no}, #{user_id} )
	</insert>
	<update id="updateComment" parameterType="db.CmtDataBean">
		UPDATE pao_comment 
		SET	comment_content = #{comment_content} 
		WHERE comment_id = #{comment_id}
	</update>
	<delete id="deleteComment" parameterType="int">
		DELETE FROM pao_comment
		WHERE comment_id = #{comment_id}
	</delete>
	<select id="getCmtCount" resultType="int">
		SELECT count(*) 
		FROM pao_comment
	</select>
	<select id="getComment" parameterType="int" resultType="db.CmtDataBean">
		SELECT * 
		FROM pao_comment 
		WHERE board_no=#{board_no} 
		ORDER BY comment_id DESC
	</select>
	<select id="getComments" parameterType="java.util.Map" resultType="db.CmtDataBean">
		SELECT comment_id,board_no,user_id,comment_content,comment_reg_date,r
		FROM (
			SELECT comment_id,board_no,user_id,comment_content,comment_reg_date,rownum r 
			FROM (
				SELECT comment_id,board_no,user_id,comment_content,comment_reg_date 
				FROM pao_comment 
				ORDER BY comment_reg_date DESC
				)
			ORDER BY comment_reg_date DESC)
		WHERE r &gt;= #{start} 
		AND r &lt;= #{end}
	</select>
	<!--/////////////////////////////////////////////////// end-line pao_comment table ///////////////////////////////////////////////////-->
</mapper>