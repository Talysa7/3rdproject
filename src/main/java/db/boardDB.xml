<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="board">
<!-- talysa7 -->
	<select id="getPost" parameterType="int" resultType="db.BoardDataBean">
		select * from pao_view_board where board_no=#{board_no}
	</select>
	<select id="getPostList" parameterType="int" resultType="db.BoardDataBean">
		select *
		from pao_view_board
		order by board_level desc, board_no desc
		limit #{startRowNumber},#{endRowNumber}
	</select>
	<select id="getPostsCount" resultType="int">
		SELECT count(*) FROM pao_board
	</select>
	<update id="addViewCount" parameterType="int">
		UPDATE pao_board SET board_view_count=board_view_count+1 WHERE board_no=#{board_no}
	</update>


	<!-- 요거도 셀렉트키 바꿔서 확인필요. -->
	<insert id="insertBoard_no" parameterType="db.BoardDataBean" keyProperty="board_no">
       insert into pao_board (board_title, board_content, board_view_count, board_level, board_contact , board_reg_date, user_id )
      values(#{board_title}, #{board_content}, 0 , 0, #{board_contact}, current_timestamp, #{user_id})
      <selectKey keyProperty="board_no" resultType="int" order="AFTER">
         SELECT LAST_INSERT_ID()
      </selectKey>
   	</insert>
   	<insert id="insertTrip" parameterType="db.TripDataBean" keyProperty="trip_id">
   		insert into pao_trip(board_no, trip_member_count, coord_id, start_date, end_date) values(#{board_no},#{trip_member_count},#{coord_id},#{start_date},#{end_date})
	   	<selectKey keyProperty="trip_id" resultType="int" order="AFTER">
	       SELECT LAST_INSERT_ID()
	    </selectKey>
    </insert>
<!-- svc 단에서는 이 쿼리 안 씀. -->
	<select id="getBoard" parameterType="int">
		select * from pao_board where board_no=#{board_no}
	</select>
	<update id="updateBoard" parameterType="db.BoardDataBean">
		UPDATE pao_board SET board_title=#{board_title}, board_content=#{board_content},  board_level=#{board_level}, board_contact=#{board_contact} WHERE board_no=#{board_no}
	</update>
	<delete id="deletePost" parameterType="int">
		DELETE FROM pao_board WHERE board_no=#{board_no}
	</delete>

<!-- not used
	<select id="getBoardTags" parameterType="int" resultType="java.util.List">
		SELECT tag_value
		FROM pao_tag
		WHERE tag_id in
		(
			SELECT tag_id
			FROM pao_trip_tag
			WHERE b_no=#{b_no}
		)
	</select>
-->
	<select id="getTripList" parameterType="int" resultType="java.util.List">
		SELECT * 
		FROM pao_trip 
		WHERE board_no=#{board_no}
	</select>
	<select id="getTripIds" parameterType="int" resultType="java.util.List">
		select trip_id from pao_trip where board_no=#{board_no}
	</select>
	<select id="getTrip" parameterType="int" resultType="db.TripDataBean">
		SELECT * 
		FROM pao_trip 
		WHERE trip_id=#{trip_id}
	</select>
	<!-- trip insert -->
	<insert id="addTrip" parameterType="db.TripDataBean">
		insert into pao_trip
		values(#{board_no}, #{trip_id}, #{trip_member_count}, #{coord_id}, #{start_date}, #{end_date})
	</insert>
	<!-- trip UPDATE -->
	<update id="addBoardViewCount" parameterType="int">
		UPDATE pao_board
		SET board_view_count=board_view_count+1
		WHERE board_no=#{board_no}
	</update>
	<update id="updateTrip" parameterType="db.BoardDataBean">
		UPDATE pao_trip
		SET trip_member_count=#{trip_member_count}, coord_id=#{coord_id},
		start_date=#{start_date}, end_date=#{end_date}
		WHERE trip_id=#{trip_id}
	</update>
	<update id="setBoardLevel" parameterType="db.BoardDataBean">
		UPDATE pao_board
		SET board_level=#{board_level}
		WHERE board_no=#{board_no}
	</update>
	<!-- trip delete -->
	<delete id="deleteTrip" parameterType="int">
		delete FROM pao_trip
		WHERE trip_id=#{trip_id}
	</delete>	
	<select id="getCoordId" parameterType="int" resultType="int">
		select coord_id from pao_trip where trip_id=#{trip_id}
	</select>
	<select id="advanceSearchByDate" parameterType="java.util.Map" resultType="db.BoardDataBean">
		<![CDATA[
		select * from pao_view_board where board_no in
		(select board_no from pao_trip where start_date>=STR_TO_DATE(#{fromDate},'%m/%d/%Y') and end_date<=STR_TO_DATE(#{toDate},'%m/%d/%Y'))
		]]>
	</select>
	<select id="advanceSearchByPeriod" parameterType="java.util.Map" resultType="db.BoardDataBean">
		<![CDATA[
		select * from pao_view_board where board_no in
		(select board_no from pao_trip where DATEDIFF(end_date,start_date)=#{searchPeriod} )
		]]>
	</select>
	<!--/////////////////////////////////////////////////// start-line pao_comment table ///////////////////////////////////////////////////-->
	<insert id="insertComment" parameterType="db.CmtDataBean">
		INSERT INTO pao_comment (comment_content, comment_reg_date, board_no, user_id)
		VALUES(#{comment_content}, now(), #{board_no}, #{user_id})
	</insert>
	<update id="updateComment" parameterType="db.CmtDataBean">
		UPDATE pao_comment
		SET	comment_content = #{comment_content}
		WHERE comment_id = #{comment_id}
	</update>
	<delete id="deleteComment" parameterType="int">
		DELETE FROM pao_comment
		WHERE comment_id = #{comment_id}
	</delete>
	<select id="getCmtCount" resultType="int">
		SELECT count(*)
		FROM pao_comment
	</select>
	<select id="getComment" parameterType="int" resultType="db.CmtDataBean">
		SELECT *
		FROM pao_comment
		WHERE board_no=#{board_no}
		ORDER BY comment_id DESC
	</select>
	<select id="getComments" parameterType="java.util.Map" resultType="db.CmtDataBean">
		SELECT comment_id, comment_content, comment_reg_date, board_no, user_id, r
		FROM (
			SELECT comment_id, comment_content, comment_reg_date, board_no, user_id, rownum r
			FROM (
				SELECT comment_id, comment_content, comment_reg_date, board_no, user_id
				FROM pao_comment
				ORDER BY comment_reg_date DESC
				)
			ORDER BY comment_reg_date DESC
			)
		WHERE r &gt;= #{start} AND r &lt;= #{end}
	</select>
	<select id="getPostByKeyword" parameterType="String" resultType="db.BoardDataBean">
		select *
		from pao_view_board
		where board_title like #{keyword} or board_content like #{keyword}
	</select>
	<select id="getPostByUserName" parameterType="String" resultType="db.BoardDataBean">
		select *
		from pao_view_board
		where user_name like #{keyword} or user_id like #{keyword}
	</select>
	<!--/////////////////////////////////////////////////// end-line pao_comment table ///////////////////////////////////////////////////-->
</mapper>
