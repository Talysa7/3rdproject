<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="location">
	<select id="getRegions" parameterType="int" resultType="java.util.List">
		SELECT region_id FROM pao_region_match WHERE coord_id=#{coord_id}
	</select>
	
	<!--/////////////////////////////////////////////////// start-line pao_coordinate table ///////////////////////////////////////////////////-->
	<insert id="insertCoord" parameterType="db. CoordDataBean" keyProperty="coord_id">
		INSERT INTO pao_coordinate 
		VALUES(
				(
				SELECT country_id 
				FROM pao_country 
				WHERE country_code=#{country_code}
				), #{coord_long}, #{coord_lat}, #{coord_order}, SEQ_pao_coordinate_coord_id.NEXTVAL)
		<selectKey keyProperty="coord_id" resultType="int" order="AFTER">
			SELECT SEQ_pao_coordinate_coord_id.currval FROM dual
		</selectKey>
	</insert>
 	<insert id="insertCal" parameterType="db. CoordDataBean">
		INSERT INTO pao_calendar VALUES(TO_DATE(#{cal_start_date},'MM/DD/YYYY'), TO_DATE(#{cal_end_date},'MM/DD/YYYY'),#{coord_id},#{td_trip_id})
	</insert>
	<select id="selectDetail" parameterType="int" resultType="db. CoordDataBean">
		SELECT * FROM pao_calendar WHERE td_trip_id IN(SELECT td_trip_id FROM pao_trip_detail WHERE tb_no=#{tb_no})
	</select>
	<select id="selectCoordinate" parameterType="int" resultType="db. CoordDataBean">
		SELECT * FROM pao_coordinate WHERE coord_id IN(SELECT coord_id FROM pao_calendar WHERE td_trip_id IN(SELECT td_trip_id FROM pao_trip_detail WHERE tb_no=#{tb})) 
	</select>
	<select id="selectCountry" parameterType="int" resultType="db. CoordDataBean">	
		SELECT * FROM pao_country WHERE country_id IN(
		SELECT country_id FROM pao_coordinate WHERE coord_id IN(
		SELECT coord_id FROM pao_calendar WHERE td_trip_id IN(
		SELECT td_trip_id FROM pao_trip_detail WHERE tb_no=#{tb_no})))
	</select>
	
	<!-- getTripDetail 에서 쓰는 쿼리 모음  -->
	<!-- FIXME : getTripDetail 자체가 join 이나 서브쿼리로 해결 될 수 없는지 연구해봐야겠다 -->
	<select id="getCalendar" parameterType="int" resultType="db. CoordDataBean">
		SELECT * FROM pao_calendar WHERE td_trip_id=#{td_trip_id}
	</select>
	<select id="getCoordLong" parameterType="int" resultType="double">
		SELECT coord_long FROM pao_coordinate WHERE coord_id=#{coord_id}
	</select>
	<select id="getCoordLat" parameterType="int" resultType="double">
		SELECT coord_lat FROM pao_coordinate WHERE coord_id=#{coord_id}
	</select>
	<select id="getCountryName" parameterType="int" resultType="String">
		SELECT country_name FROM pao_country WHERE country_id=
		(SELECT country_id FROM pao_coordinate WHERE coord_id=#{coord_id})
	</select>
	<!-- FIXME : 여기까지 getTripDetail -->
	
	<!-- getPhotoLoc 에서 쓰는 쿼리 모음 -->
	<select id="getTripIds" resultType="int">
		SELECT td_trip_id FROM pao_trip_detail WHERE tb_no=#{tb_no}
	</select>
	<select id="getTripCountry" parameterType="int" resultType="String">
		SELECT country_name FROM pao_country WHERE country_id=
		(SELECT country_id FROM pao_coordinate WHERE coord_id=
		(SELECT coord_id FROM pao_calendar WHERE td_trip_id=#{td_trip_id}))
	</select>
	<select id="getMyTrips" parameterType="String" resultType="db. CoordDataBean">
		SELECT ca.cal_start_date, ca.cal_end_date, ca.coord_id, ca.td_trip_id, co.coord_long, co.coord_lat, co.coord_order, co.coord_id, ctr.country_name 
		FROM (
			SELECT cal_start_date, cal_end_date, coord_id, td_trip_id 
			FROM pao_calendar 
			WHERE td_trip_id IN 
				(
				SELECT td_trip_id 
				FROM pao_trip_detail 
				WHERE tb_no IN 
					(
					SELECT tb_no 
					FROM pao_trip_board 
					WHERE user_id=#{user_id}
					)
				)
			) ca, pao_coordinate co, pao_country ctr 
		WHERE ca.coord_id = co.coord_id 
		AND co.country_id = ctr.country_id
	</select>
	<!--/////////////////////////////////////////////////// end-line pao_coordinate table ///////////////////////////////////////////////////-->
</mapper>